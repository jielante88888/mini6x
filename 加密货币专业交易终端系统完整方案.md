**加密货币专业交易终端 · 支持多交易所 · 含市场异动与AI分析系统  
（适用于任意 IDE 环境）



使用sequential-thinking  mcp读取本文内容，使用Spec-Kit工作流进行规划。



必须严格按照Spec-Kit工作流程进行（Spec-Kit已在项目范围安装并完成初始化）

- 在任何任务执行前**，必须检查并确认遵循Spec-Kit规范
- **所有任务清单必须以Spec-Kit生成的任务清单为准**
- **每个任务完成后必须更新任务状态**
- **如遇到任何开发问题，首先回到Spec-Kit工作流程**
- **严禁跳过Spec-Kit工作流程的任何步骤
- 每个任务清单开头必须添加此Spec-Kit说明！



本地资源：

交易所官方API文档数据在：“OKX币安交易所开发数据包”文件夹

API数据来源（官方文档）：
binance：https://developers.binance.com/docs/binance-spot-api-docs
OKX：https://www.okx.com/docs-v5/zh/#overview

本地Flutter SDK路径：E:\flutter

本地安装有Docker。

配置有chrome mcp可以用于浏览器查询数据

开发全程使用中文进行交流。

---

## 一、项目目标

构建一个 **支持币安和OKX双交易所、AI驱动、可扩展的专业交易终端系统**，  
实现统一行情展示、智能策略执行、自动化风控、资产管理和盈亏分析。

前端使用 **Dart + Flutter（Material 3 + Riverpod）** 构建桌面UI  
后端使用 **Python（FastAPI + asyncio）** 实现多交易所核心逻辑。

专业交易终端系统仅部署在**Windows本地**，不在服务器运行。

**仅开发Windows桌面端，不开发其他系统！**

**现货交易和合约交易面板完全区分：**

- 现货交易页面：包含正常的现货交易功能和现货交易策略功能
- 合约交易页面：包含合约交易内容和合约交易策略功能

---

## 二、核心架构

| 层级   | 模块说明                                     | 开发语言           |
| ---- | ---------------------------------------- | -------------- |
| UI 层 | 行情展示、交易面板、市场异动、设置中心、条件构建器、自动交易管理、通知中心    | Dart + Flutter |
| 逻辑层  | 策略引擎、风控系统、账户分析、数据聚合、条件触发引擎、自动交易引擎、通知系统   | Python         |
| 适配层  | 交易所 API 统一适配（Adapter 模式）、订单执行器           | Python         |
| 触发层  | 价格条件处理器、技术指标条件处理器、成交量条件处理器、时间条件处理器       | Python         |
| 执行层  | 订单管理器、执行引擎、风险检查器、仓位管理器                   | Python         |
| 通知层  | 通知管理器、多渠道通知（弹窗、桌面、Telegram、邮件、声音）、通知模板系统 | Python         |
| 数据层  | SQLite / PostgreSQL + Redis 消息队列         | Python         |
| AI 层 | 本地与云端模型结合（LSTM + GPT 系列）、智能条件推荐、自动参数优化   | Python         |

---

## 三、全局特性

**平台与部署：**

- 平台：仅Windows桌面端（不支持Web、移动端等其他平台）
- 部署方式：本地部署，不在服务器运行
- 桌面UI框架：Dart + Flutter（Material 3 + Riverpod）
- 后端框架：Python（FastAPI + asyncio）

**语言与主题：**

- 默认语言：简体中文（支持中英文切换）
- 主题：仅暗色模式

**数据与通信：**

- 数据更新：REST + WebSocket
- 交易所支持：币安（Binance）和OKX
- 数据优先级：币安优先，OKX备用
- 数据源：双交易所数据聚合与独立管理

**架构特性：**

- 模块化架构：币安和OKX专用适配层
- 双交易所设计：统一接口标准，便于扩展
- 可扩展的 AI 智能分析体系
- 前后端独立部署
- 现货与合约交易功能完全分离
- 预留扩展接口：支持后续添加更多交易所

**条件触发与自动交易特性：**

- 强大的多条件组合引擎：支持AND、OR、NOT逻辑运算和嵌套条件
- 全面的触发条件类型：价格、技术指标、成交量、资金流向、时间、市场异动等
- 智能通知系统：支持弹窗、桌面、Telegram、邮件、声音等多渠道通知
- 自动下单执行：支持现货和合约的自动交易执行，包含风险控制机制
- 可视化条件构建器：拖拽式操作，无需编程知识即可配置复杂条件
- 实时执行监控：条件触发状态、自动下单执行进度、通知发送情况实时显示
- 智能风控集成：自动下单前的风险检查和异常处理机制
- 条件模板库：预设常用条件组合模板，支持一键导入和使用

---

## 四、UI 页面结构

```
/ui/pages/
├── market/
│   ├── overview/         # 行情总览（默认市值排行，可排序）
│   ├── market_alerts/    # 市场异动（实时波动检测）
│   └── exchange_filter/  # 数据源筛选与状态显示
├── spot_trade/           # 现货交易面板（现货交易 + 现货策略）
├── futures_trade/        # 合约交易面板（合约交易 + 合约策略）
├── strategy_center/      # 策略交易与AI助手
│   ├── condition_builder/ # 条件组合构建器（拖拽式条件设计）
│   ├── auto_trading/      # 自动交易管理（执行状态、参数调整）
│   └── notification_center/ # 通知中心（历史记录、模板管理）
├── positions/            # 持仓与盈亏
├── orders/               # 历史订单与成交记录
├── account_center/       # 账户与资产管理
├── reports/              # 盈亏报表与绩效分析
└── settings/
    ├── data_sources/     # 数据源管理与新增接口
    ├── trading_settings/ # 交易设置（现货/合约分离）
    └── ai_settings/      # AI模型与策略配置
```

**交易面板分离设计：**

1. **现货交易页面**
   
   - 现货交易下单区（市价单、限价单）
   - 现货交易策略模块（网格、马丁格尔、套利等）
   - 现货持仓与订单管理
   - 现货市场深度与实时行情

2. **合约交易页面**
   
   - 合约交易下单区（开仓、平仓、止损、止盈）
   - 合约交易策略模块（趋势跟踪、震荡、套利等）
   - 合约持仓与风险率显示
   - 合约市场深度、资金费率、持仓量

**布局要求：**

- 上部：行情展示区域
- 下部：市场异动模块（可折叠）
- 左侧：导航栏（行情 / 现货交易 / 合约交易 / 策略 / 账户 / 报表 / 设置）
- 顶部：币种搜索、交易所状态、网络延迟、切换现货/合约模式
- 底部：系统状态栏（当前数据源、版本号、Windows系统状态）

---

## 五、Material 3 + Riverpod UI设计规范

### 设计哲学与核心理念

**Material 3设计原则：**

- **动态色彩系统**：根据主题自动调整颜色方案
- **自适应布局**：响应式设计，支持不同屏幕尺寸
- **直观交互**：符合用户直觉的操作反馈
- **无障碍友好**：支持键盘导航和屏幕阅读器
- **一致性体验**：统一的视觉语言和交互模式

**Riverpod状态管理原则：**

- **全局状态共享**：单一数据源，避免状态重复
- **类型安全**：强类型状态定义，编译时错误检查
- **性能优化**：精准的依赖追踪，避免不必要的重建
- **可测试性**：状态独立，便于单元测试
- **模块化架构**：按功能模块组织Provider层次

### 颜色系统与主题设计

**暗色主题配色方案：**

```dart
// 主色调 - 暗色系
const ColorScheme darkColorScheme = ColorScheme(
  brightness: Brightness.dark,
  primary: Color(0xFF1DB954),        // 主绿色（金融主题色）
  onPrimary: Color(0xFF000000),
  primaryContainer: Color(0xFF2D7D31),
  onPrimaryContainer: Color(0xFFA5D6A7),

  // 次要色 - 橙色警示
  secondary: Color(0xFFFF9800),
  onSecondary: Color(0xFF000000),
  secondaryContainer: Color(0xFFFFAB40),
  onSecondaryContainer: Color(0xFF000000),

  // 错误色 - 红色
  error: Color(0xFFCF6679),
  onError: Color(0xFF000000),
  errorContainer: Color(0xFFEF5350),
  onErrorContainer: Color(0xFFFFCDD2),

  // 背景色系
  background: Color(0xFF121212),     // 主背景
  onBackground: Color(0xFFFFFFFF),

  surface: Color(0xFF1E1E1E),        // 卡片背景
  onSurface: Color(0xFFFFFFFF),
  surfaceVariant: Color(0xFF2A2A2A), // 卡片变体
  onSurfaceVariant: Color(0xFFB0B0B0),

  // 边框和分割线
  outline: Color(0xFF404040),
  outlineVariant: Color(0xFF303030),

  // 透明覆盖层
  surfaceTint: Color(0xFF1DB954),
  inverseSurface: Color(0xFFFFFBFE),
  inverseOnSurface: Color(0xFF1C1B1F),
  inversePrimary: Color(0xFF4CAF50),
  shadow: Color(0xFF000000),
  scrim: Color(0xFF000000),
  surfaceContainerHighest: Color(0xFF3D3D3D),
  surfaceContainerHigh: Color(0xFF2E2E2E),
  surfaceContainerMedium: Color(0xFF2A2A2A),
  surfaceContainerLow: Color(0xFF1E1E1E),
  surfaceContainerLowest: Color(0xFF000000),
);
```

**功能颜色定义：**

```dart
// 金融专用颜色
class TradingColors {
  // 价格涨跌
  static const Color profitGreen = Color(0xFF00E676);   // 盈利绿
  static const Color lossRed = Color(0xFFFF5252);       // 亏损红
  static const Color neutralGrey = Color(0xFF757575);   // 中性灰

  // 交易状态
  static const Color completedGreen = Color(0xFF4CAF50);
  static const Color pendingOrange = Color(0xFFFF9800);
  static const Color cancelledRed = Color(0xFFF44336);
  static const Color filledBlue = Color(0xFF2196F3);

  // 特殊功能色
  static const Color aiPurple = Color(0xFF9C27B0);       // AI功能
  static const Color strategyTeal = Color(0xFF009688);    // 策略功能
  static const Color notificationAmber = Color(0xFFFFC107); // 通知
  static const Color gridViolet = Color(0xFF7E57C2);      // 网格策略

  // 图表专用色
  static const Color chartBlue = Color(0xFF2196F3);
  static const Color chartOrange = Color(0xFFFF9800);
  static const Color chartGreen = Color(0xFF4CAF50);
  static const Color chartRed = Color(0xFFF44336);
  static const Color chartPurple = Color(0xFF9C27B0);
  static const Color chartCyan = Color(0xFF00BCD4);
}
```

### Riverpod状态管理架构

**核心Provider层次结构：**

```dart
// 全局状态Provider
@riverpod
class GlobalAppController extends _$GlobalAppController {
  @override
  StateNotifier<GlobalAppState> build() {
    return GlobalAppState();
  }
}

// 市场数据Provider
@riverpod
class MarketDataController extends StateNotifier<AsyncValue<MarketData>> {
  MarketDataController(this._exchangeService) : super(const AsyncValue.loading()) {
    loadMarketData();
  }

  final ExchangeService _exchangeService;

  Future<void> loadMarketData() async {
    try {
      state = const AsyncValue.loading();
      final data = await _exchangeService.fetchMarketData();
      state = AsyncValue.data(data);
    } catch (e, stack) {
      state = AsyncValue.error(e, stack);
    }
  }
}

// 交易状态Provider
@riverpod
class TradingController extends StateNotifier<TradingState> {
  TradingController(this._tradingService) : super(TradingState()) {
    initializeTradingState();
  }

  final TradingService _tradingService;

  void initializeTradingState() {
    // 初始化交易状态
  }

  Future<OrderResult> placeOrder(OrderRequest request) async {
    // 下单逻辑
  }
}

// 策略管理Provider
@riverpod
class StrategyController extends StateNotifier<List<TradingStrategy>> {
  StrategyController(this._strategyService) : super([]) {
    loadStrategies();
  }

  final StrategyService _strategyService;

  void loadStrategies() async {
    final strategies = await _strategyService.loadUserStrategies();
    state = strategies;
  }

  void addStrategy(TradingStrategy strategy) {
    state = [...state, strategy];
  }
}
```

### 关键UI组件设计

**1. 行情展示组件**

```dart
// 行情卡片组件
class MarketCard extends ConsumerWidget {
  const MarketCard({
    Key? key,
    required this.symbol,
    required this.marketData,
  }) : super(key: key);

  final String symbol;
  final MarketData marketData;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final price = marketData.price;
    final change = marketData.priceChangePercent24h;

    return Card(
      elevation: 2,
      color: Theme.of(context).colorScheme.surface,
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(
                  symbol,
                  style: Theme.of(context).textTheme.titleMedium?.copyWith(
                    fontWeight: FontWeight.bold,
                  ),
                ),
                IconButton(
                  onPressed: () => _showDetails(context, ref, symbol),
                  icon: const Icon(Icons.info_outline, size: 20),
                ),
              ],
            ),
            const SizedBox(height: 8),
            Text(
              '\${price.toStringAsFixed(2)}',
              style: Theme.of(context).textTheme.headlineSmall?.copyWith(
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 4),
            Row(
              children: [
                Icon(
                  change >= 0 ? Icons.trending_up : Icons.trending_down,
                  color: change >= 0 
                    ? TradingColors.profitGreen 
                    : TradingColors.lossRed,
                  size: 16,
                ),
                const SizedBox(width: 4),
                Text(
                  '${change >= 0 ? '+' : ''}${change.toStringAsFixed(2)}%',
                  style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                    color: change >= 0 
                      ? TradingColors.profitGreen 
                      : TradingColors.lossRed,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}

// 行情列表组件
class MarketListView extends ConsumerWidget {
  const MarketListView({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final marketDataState = ref.watch(marketDataControllerProvider);

    return marketDataState.when(
      loading: () => const Center(child: CircularProgressIndicator()),
      error: (error, stack) => _buildErrorWidget(context, error),
      data: (data) => _buildMarketGrid(context, data),
    );
  }

  Widget _buildMarketGrid(BuildContext context, List<MarketData> data) {
    return GridView.builder(
      padding: const EdgeInsets.all(16),
      gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
        crossAxisCount: 4,
        childAspectRatio: 1.2,
        crossAxisSpacing: 12,
        mainAxisSpacing: 12,
      ),
      itemCount: data.length,
      itemBuilder: (context, index) {
        final market = data[index];
        return MarketCard(
          symbol: market.symbol,
          marketData: market,
        );
      },
    );
  }
}
```

**2. 交易控制面板组件**

```dart
// 下单面板组件
class OrderPanel extends ConsumerStatefulWidget {
  const OrderPanel({Key? key}) : super(key: key);

  @override
  ConsumerState<OrderPanel> createState() => _OrderPanelState();
}

class _OrderPanelState extends ConsumerState<OrderPanel> {
  final _orderFormKey = GlobalKey<FormState>();
  final _amountController = TextEditingController();
  final _priceController = TextEditingController();

  OrderType _orderType = OrderType.limit;
  OrderSide _orderSide = OrderSide.buy;
  String _selectedSymbol = 'BTCUSDT';

  @override
  Widget build(BuildContext context) {
    final tradingState = ref.watch(tradingControllerProvider);

    return Card(
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            _buildOrderTypeSelector(),
            const SizedBox(height: 16),
            _buildSymbolSelector(),
            const SizedBox(height: 16),
            _buildOrderSideSelector(),
            const SizedBox(height: 16),
            _buildPriceInput(),
            const SizedBox(height: 16),
            _buildAmountInput(),
            const SizedBox(height: 16),
            _buildActionButtons(tradingState),
          ],
        ),
      ),
    );
  }

  Widget _buildOrderTypeSelector() {
    return Row(
      children: [
        Text('订单类型:', style: Theme.of(context).textTheme.bodyMedium),
        const SizedBox(width: 16),
        Expanded(
          child: SegmentedButton<OrderType>(
            segments: const [
              ButtonSegment(value: OrderType.market, label: Text('市价')),
              ButtonSegment(value: OrderType.limit, label: Text('限价')),
            ],
            selected: {_orderType},
            onSelectionChanged: (Set<OrderType> newSelection) {
              setState(() {
                _orderType = newSelection.first;
              });
            },
            style: SegmentedButton.styleFrom(
              backgroundColor: Theme.of(context).colorScheme.surfaceVariant,
              selectedForegroundColor: Colors.white,
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildActionButtons(TradingState state) {
    return Row(
      children: [
        Expanded(
          child: FilledButton(
            onPressed: state.isLoading ? null : () => _placeOrder(ref, OrderSide.buy),
            style: FilledButton.styleFrom(
              backgroundColor: TradingColors.profitGreen,
            ),
            child: Text(state.isLoading ? '处理中...' : '买入'),
          ),
        ),
        const SizedBox(width: 12),
        Expanded(
          child: FilledButton(
            onPressed: state.isLoading ? null : () => _placeOrder(ref, OrderSide.sell),
            style: FilledButton.styleFrom(
              backgroundColor: TradingColors.lossRed,
            ),
            child: Text(state.isLoading ? '处理中...' : '卖出'),
          ),
        ),
      ],
    );
  }
}
```

**3. 图表组件设计**

```dart
// K线图表组件
class CandlestickChart extends ConsumerWidget {
  const CandlestickChart({
    Key? key,
    required this.symbol,
    this.timeframe = '1h',
  }) : super(key: key);

  final String symbol;
  final String timeframe;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final chartData = ref.watch(candlestickDataProvider(symbol, timeframe));

    return Card(
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          children: [
            _buildChartToolbar(),
            const SizedBox(height: 16),
            Expanded(
              child: chartData.when(
                loading: () => const Center(child: CircularProgressIndicator()),
                error: (error, stack) => _buildErrorWidget(context, error),
                data: (data) => _buildChartWidget(context, data),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildChartToolbar() {
    return Row(
      children: [
        IconButton(
          icon: const Icon(Icons.zoom_in),
          onPressed: () {},
        ),
        IconButton(
          icon: const Icon(Icons.zoom_out),
          onPressed: () {},
        ),
        const Spacer(),
        _buildTimeframeSelector(),
      ],
    );
  }
}
```

### 响应式布局设计

**桌面端自适应布局：**

```dart
// 主布局组件
class TradingLayout extends ConsumerWidget {
  const TradingLayout({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return Scaffold(
      backgroundColor: Theme.of(context).colorScheme.background,
      body: Row(
        children: [
          // 左侧导航栏
          NavigationRail(
            selectedIndex: ref.watch(selectedPageProvider),
            onDestinationSelected: (index) {
              ref.read(selectedPageProvider.notifier).state = index;
            },
            labelType: NavigationRailLabelType.all,
            destinations: const [
              NavigationRailDestination(
                icon: Icon(Icons.bar_chart),
                selectedIcon: Icon(Icons.bar_chart),
                label: Text('行情'),
              ),
              NavigationRailDestination(
                icon: Icon(Icons.swap_horiz),
                selectedIcon: Icon(Icons.swap_horiz),
                label: Text('现货'),
              ),
              NavigationRailDestination(
                icon: Icon(Icons.account_balance_wallet),
                selectedIcon: Icon(Icons.account_balance_wallet),
                label: Text('合约'),
              ),
            ],
          ),
          const VerticalDivider(thickness: 1, width: 1),
          // 主要内容区域
          Expanded(
            child: Column(
              children: [
                // 顶部工具栏
                _buildTopToolbar(),
                // 内容页面
                Expanded(
                  child: _buildMainContent(),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildTopToolbar() {
    return Container(
      height: 64,
      padding: const EdgeInsets.symmetric(horizontal: 16),
      decoration: BoxDecoration(
        color: Theme.of(context).colorScheme.surface,
        border: Border(
          bottom: BorderSide(
            color: Theme.of(context).colorScheme.outline,
          ),
        ),
      ),
      child: Row(
        children: [
          Text(
            '加密货币交易终端',
            style: Theme.of(context).textTheme.headlineSmall,
          ),
          const Spacer(),
          _buildStatusIndicators(),
        ],
      ),
    );
  }
}
```

### 无障碍与可访问性

**无障碍功能实现：**

```dart
// 无障碍支持组件
class AccessibleButton extends StatelessWidget {
  const AccessibleButton({
    Key? key,
    required this.child,
    required this.onPressed,
    this.semanticLabel,
  }) : super(key: key);

  final Widget child;
  final VoidCallback? onPressed;
  final String? semanticLabel;

  @override
  Widget build(BuildContext context) {
    return Semantics(
      button: true,
      label: semanticLabel,
      child: FocusableActionDetector(
        shortcuts: const <LogicalKeySet, Intent>{
          LogicalKeySet(LogicalKeyboardKey.enter): ActivateIntent(),
          LogicalKeySet(LogicalKeyboardKey.space): ActivateIntent(),
        },
        actions: <Type, Action<Intent>>{
          ActivateIntent: CallbackAction<ActivateIntent>(
            onInvoke: (_) => onPressed?.call(),
          ),
        },
        child: MouseRegion(
          cursor: SystemMouseCursors.click,
          child: GestureDetector(
            onTap: onPressed,
            child: child,
          ),
        ),
      ),
    );
  }
}

// 键盘导航支持
class KeyboardNavigationWrapper extends ConsumerWidget {
  const KeyboardNavigationWrapper({
    Key? key,
    required this.child,
  }) : super(key: key);

  final Widget child;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return FocusScope(
      child: child,
    );
  }
}
```

### 性能优化策略

**优化原则：**

```dart
// 高效列表组件
class OptimizedMarketList extends ConsumerWidget {
  const OptimizedMarketList({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final marketData = ref.watch(marketDataProvider);

    return ListView.builder(
      itemCount: marketData.length,
      cacheExtent: 500, // 缓存500像素高度的内容
      itemBuilder: (context, index) {
        return MarketDataItem(
          data: marketData[index],
          // 使用const构造函数减少重建
        );
      },
    );
  }
}

// 状态优化Provider
@Riverpod(keepAlive: true)
class PersistentMarketController extends StateNotifier<AsyncValue<List<MarketData>>> 
    with AutoDisposeNotifierMixin {
  PersistentMarketController() : super(const AsyncValue.loading()) {
    loadData();
  }

  final MarketService _marketService = MarketService();

  @override
  bool get keepAlive => true;

  void loadData() async {
    // 实现数据加载逻辑
  }
}
```

---

## 六、数据源与多交易所架构

## 五、数据源与多交易所架构

### 1. 设计原则

- 双交易所架构：币安（Binance）和OKX专用适配
- 模块化设计：统一接口标准，便于后续扩展
- 优先优化核心功能：现货 + 合约完整功能实现
- 现货和合约数据源完全独立管理
- 为后续扩展其他交易所预留标准接口

### 2. 目录结构

```
/core/exchange_adapters/
├── base_adapter.py              # 基础适配器抽象类
├── binance_adapter/             # 币安交易所适配器
│   ├── adapter.py              # 币安主适配器
│   ├── spot_adapter.py         # 币安现货适配器
│   ├── futures_adapter.py      # 币安合约适配器
│   └── constants.py           # 币安常量配置
├── okx_adapter/                # OKX交易所适配器
│   ├── adapter.py             # OKX主适配器
│   ├── spot_adapter.py        # OKX现货适配器
│   ├── derivatives_adapter.py # OKX衍生品适配器
│   └── constants.py           # OKX常量配置
└── future_expansion/           # 预留扩展目录
    └── README.md              # 扩展指南
```

### 3. 标准接口定义

每个适配器继承自 `BaseExchangeAdapter`，需实现：

```python
class BaseExchangeAdapter:
    def connect(self): ...
    def get_markets(self): ...
    def get_ticker(self, symbol): ...
    def get_orderbook(self, symbol): ...
    def place_order(self, order_data): ...
    def cancel_order(self, order_id): ...
    def get_account_balance(self): ...

class SpotAdapter(BaseExchangeAdapter):
    """现货交易适配器"""
    def get_spot_account(self): ...
    def place_spot_order(self, order_data): ...

class FuturesAdapter(BaseExchangeAdapter):
    """合约交易适配器"""
    def get_futures_account(self): ...
    def get_positions(self): ...
    def set_leverage(self, leverage): ...
```

### 4. 双交易所数据源管理中心

**币安交易所配置：**

- 现货交易：支持现货交易、现货策略
- 合约交易：支持永续合约、交割合约
- 数据源管理：独立现货/合约数据流
- API状态监控：实时连接状态检测

**OKX交易所配置：**

- 现货交易：支持现货交易、现货策略  
- 合约交易：支持永续合约、期权
- 数据源管理：独立现货/合约数据流
- API状态监控：实时连接状态检测

**配置管理：**

```json
{
  "exchanges": {
    "binance": {
      "name": "币安",
      "spot": {
        "api_endpoint": "https://api.binance.com",
        "ws_endpoint": "wss://stream.binance.com:9443/ws",
        "support_features": ["spot_trading", "spot_strategies"],
        "status": "active",
        "priority": 1
      },
      "futures": {
        "api_endpoint": "https://fapi.binance.com",
        "ws_endpoint": "wss://fstream.binance.com/ws",
        "support_features": ["futures_trading", "futures_strategies", "perpetual"],
        "status": "active",
        "priority": 1
      }
    },
    "okx": {
      "name": "OKX",
      "spot": {
        "api_endpoint": "https://www.okx.com",
        "ws_endpoint": "wss://ws.okx.com:8443/ws/v5/public",
        "support_features": ["spot_trading", "spot_strategies"],
        "status": "active",
        "priority": 2
      },
      "derivatives": {
        "api_endpoint": "https://www.okx.com",
        "ws_endpoint": "wss://ws.okx.com:8443/ws/v5/public",
        "support_features": ["derivatives_trading", "derivatives_strategies", "perpetual", "options"],
        "status": "active",
        "priority": 2
      }
    }
  }
}
```

**管理功能：**

- 双交易所独立配置和启用
- 现货/合约数据源独立管理
- 交易所优先级设置（币安优先，OKX备用）
- API连通性测试和状态监控
- 故障自动切换机制

### 5. 数据流机制

**币安数据处理：**

- 现货数据：由 `binance_spot_aggregator.py` 处理
- 合约数据：由 `binance_futures_aggregator.py` 处理
- 独立WebSocket连接管理

**OKX数据处理：**

- 现货数据：由 `okx_spot_aggregator.py` 处理  
- 衍生品数据：由 `okx_derivatives_aggregator.py` 处理
- 独立WebSocket连接管理

**数据融合逻辑：**

- 按交易所优先级进行数据选择（币安优先）
- 现货与合约数据完全独立处理
- 时间戳对齐与数据同步
- 异常时自动切换到备用交易所
- 策略与AI模块调用标准化数据接口

### 6. 验收标准

| 项目        | 目标   | 指标        | 备注           |
| --------- | ---- | --------- | ------------ |
| 数据源切换     | 即时生效 | 延迟 ≤ 1秒   | 币安↔OKX自动切换   |
| 交易所连接状态   | 实时监控 | 检测 ≤ 2秒   | 双交易所独立监控     |
| 行情同步      | 数据差异 | ≤ 0.1%    | 币安vs OKX数据对比 |
| 容错机制      | 自动切换 | 恢复 ≤ 3秒   | 主交易所故障自动切换备用 |
| 现货/合约数据分离 | 完全隔离 | 数据准确性100% | 币安和OKX独立处理   |
| API稳定性    | 持续运行 | 24小时无断线   | 双交易所API监控    |

---

## 六、行情系统

**现货行情功能：**

- 默认按币种市值排行展示现货市场
- 支持排序字段：市值 / 最新价 / 涨跌幅 / 成交额 / 净流入
- 榜单类型：涨幅榜 / 跌幅榜 / 成交额榜 / 资金流榜（现货）
- 点击币种跳转至现货行情详情页（现货K线图、深度、现货成交明细）
- 现货K线时间周期：1m / 5m / 15m / 1h / 4h / 1d / 1w
- 现货技术指标：MA、EMA、MACD、RSI、BOLL、VWAP

**合约行情功能：**

- 展示所有合约交易对的实时价格、涨跌幅、成交量
- 合约持仓量、资金费率、深度图
- 永续合约标记价格与资金费率实时更新
- 合约K线图表（支持价格、持仓量、资金费率多维展示）
- 合约技术指标：MA、EMA、MACD、RSI、BOLL、VWAP、资金费率均线

**验收标准：**

- 刷新延迟 ≤ 1秒
- 表头排序即时响应
- WebSocket自动重连成功率 ≥ 99%
- 现货和合约数据完全分离，无混淆

---

## 七、市场异动模块

### 功能说明

实时检测市场异常波动、成交量激增、资金流变化，同时监控现货和合约市场的异动。

**现货市场异动检测条件：**

1. 单笔现货成交额 >100,000 USDT
2. 5分钟内现货价格涨跌幅 ≥ ±2%
3. 现货波动率相对均值上升 >2倍
4. 现货成交量激增（>3倍）
5. 现货净流入/净流出超过 1,000,000 USDT

**合约市场异动检测条件：**

1. 单笔合约成交额 >100,000 USDT
2. 5分钟内合约价格涨跌幅 ≥ ±2%
3. 合约波动率相对均值上升 >2倍
4. 合约成交量激增（>3倍）
5. 合约资金费率异常变动（±0.05%）
6. 合约持仓量激增（>2倍）

**显示字段：**  
| 币种 | 市场类型 | 异动类型 | 异动强度 | 时间 | 价格 | 成交额 | 成交量 | 资金流向 | 合约资金费率 |

**交互要求：**

- 实时更新并按时间倒序排列
- 支持按市场类型筛选（现货/合约）
- 支持筛选异动类型
- 点击跳转对应市场详情（现货或合约）
- 支持导出与历史查询
- 现货和合约异动独立保存24小时

**验收标准：**

- 检测延迟 ≤ 2秒
- UI更新流畅（FPS ≥ 60）
- 现货和合约异动数据完全分离
- 异动日志保存24小时准确率 ≥ 99%

---

## 八、策略与条件下单系统

### 条件触发与通知系统

**多条件组合触发：**

- 支持价格条件：现货/合约价格高于/低于指定值
- 支持技术指标条件：MA、EMA、MACD、RSI、BOLL等技术指标触发
- 支持成交量条件：现货/合约成交量突增、异动检测
- 支持资金流向条件：净流入/净流出达到阈值
- 支持资金费率条件：合约资金费率变化（仅合约）
- 支持时间条件：定时触发、交易时段判断
- 支持市场异动条件：市场波动、异常事件触发
- 支持组合条件：AND、OR、NOT逻辑运算，支持嵌套条件

**通知系统设计：**

1. **通知渠道：**
   
   - 系统内弹窗通知
   - Windows桌面通知
   - Telegram机器人推送
   - 邮件通知
   - 声音提醒
   - LED灯闪烁（硬件设备）

2. **通知模板：**
   
   - 条件触发提醒（如："BTCUSDT价格突破$50,000"）
   - 策略执行状态（如："现货网格策略第3层挂单成功"）
   - 风控预警（如："合约风险率达到80%，建议减仓"）
   - 市场异动提醒（如："ETH成交量突增300%异动检测"）

3. **通知管理：**
   
   - 支持通知优先级设置（高/中/低）
   - 支持静默时段设置（避免夜间打扰）
   - 支持通知历史记录查看
   - 支持通知内容自定义编辑

**通知触发配置示例：**

```json
{
  "notification_id": "btc_price_alert",
  "name": "BTC价格突破通知",
  "conditions": {
    "type": "AND",
    "conditions": [
      {
        "type": "price",
        "symbol": "BTCUSDT",
        "operator": ">",
        "value": 50000,
        "exchange": "binance"
      },
      {
        "type": "volume",
        "symbol": "BTCUSDT", 
        "operator": ">",
        "value": 1000000,
        "timeframe": "5m"
      }
    ]
  },
  "notification": {
    "channels": ["system_popup", "telegram", "desktop"],
    "template": "BTC价格突破$50,000，成交量放大，建议关注",
    "priority": "high"
  }
}
```

### 自动下单系统

**现货自动下单：**

- 支持限价单、市价单、止盈止损单自动执行
- 支持批量下单（多币种组合）
- 支持网格挂单自动管理
- 支持条件单连锁触发（如：止盈单触发后自动设置新的止损单）
- 支持动态调整下单参数（基于市场波动）

**合约自动下单：**

- 支持开仓、平仓、止损、止盈自动执行
- 支持杠杆动态调整（基于风险率）
- 支持对冲策略自动执行（现货对冲合约风险）
- 支持合约滚动移仓自动执行
- 支持资金费率套利自动执行

**自动下单风险控制：**

1. **下单前检查：**
   
   - 账户余额验证
   - 持仓风险率检查
   - API连接状态验证
   - 市场流动性评估
   - 异常价格过滤（防止闪崩误触发）

2. **下单参数验证：**
   
   - 价格合理性检查（偏离市价超过阈值则拒绝）
   - 数量精度验证（符合交易所规则）
   - 杠杆倍数验证（在允许范围内）
   - 最小下单金额验证

3. **异常处理机制：**
   
   - 下单失败自动重试（最多3次）
   - 交易所响应超时自动切换备用交易所
   - 网络断线自动重连并恢复挂单
   - 异常价格检测并暂停自动下单

**自动下单配置示例：**

```json
{
  "auto_order_id": "btc_dca_strategy",
  "name": "BTC定投策略",
  "type": "spot",
  "conditions": {
    "type": "OR",
    "conditions": [
      {
        "type": "price",
        "symbol": "BTCUSDT",
        "operator": "<",
        "value": 48000
      },
      {
        "type": "rsi",
        "symbol": "BTCUSDT",
        "operator": "<",
        "value": 30,
        "timeframe": "1h"
      }
    ]
  },
  "order_config": {
    "order_type": "limit",
    "side": "buy",
    "symbol": "BTCUSDT",
    "quantity": 0.001,
    "price": "market_price",
    "time_in_force": "GTC"
  },
  "risk_controls": {
    "max_daily_orders": 10,
    "max_order_value": 1000,
    "price_deviation_limit": 0.02,
    "enable_stop_loss": true,
    "stop_loss_percentage": 5
  }
}
```

### 现货交易策略系统

**现货策略模板：**

- 现货网格策略（现货价区间挂单）
- 现货马丁格尔策略（现货补仓策略）
- 现货套利策略（现货vs永续合约套利）
- 现货趋势跟踪（基于现货技术指标）
- 现货均值回归（现货价格回归策略）
- 现货定投策略（定期定额自动买入）
- 现货波段交易（基于技术指标买卖点）

**现货条件单联动：**

- 止盈单触发后自动设置新的止损单
- 止损单触发后自动减少仓位比例
- 网格策略配合条件通知自动调整网格间距
- 套利策略配合自动下单执行价差捕捉

### 合约交易策略系统

**合约策略模板：**

- 合约趋势跟踪（基于合约价格和技术指标）
- 合约震荡策略（合约区间交易）
- 合约套利策略（跨交易所合约价差）
- 合约网格策略（合约价格区间挂单）
- 合约马丁格尔（合约补仓策略）
- 合约对冲策略（现货对冲合约风险）
- 合约套利滚动（基于资金费率的套利）
- 合约波段交易（合约技术分析交易）

**合约条件单联动：**

- 开仓单触发后自动设置止损止盈
- 资金费率异常触发自动平仓
- 风险率达到预警线自动减仓
- 市场异动触发合约对冲操作

### 高级条件组合示例

**多条件组合策略：**

```json
{
  "complex_strategy": {
    "name": "BTC智能抄底策略",
    "conditions": {
      "type": "AND",
      "conditions": [
        {
          "type": "OR",
          "conditions": [
            {"type": "price", "operator": "<", "value": 47000},
            {"type": "rsi", "operator": "<", "value": 25}
          ]
        },
        {
          "type": "volume_spike",
          "operator": ">",
          "value": 2.0
        },
        {
          "type": "time_window",
          "start": "09:00",
          "end": "11:00"
        }
      ]
    },
    "actions": [
      {
        "type": "notification",
        "template": "BTC抄底信号出现，建议关注"
      },
      {
        "type": "auto_order",
        "order_type": "buy_limit",
        "quantity": 0.01,
        "price": "market_price * 0.99"
      },
      {
        "type": "set_stop_loss",
        "percentage": 3
      },
      {
        "type": "set_take_profit", 
        "percentage": 6
      }
    ]
  }
}
```

### AI策略优化

**AI扩展：**

- 自动调参（现货和合约策略参数独立优化）
- 策略推荐与信号评分
- 现货和合约策略盈亏诊断与复盘报告生成
- 跨市场套利机会发现
- 智能条件组合建议（AI推荐最优条件组合）
- 动态风险调整（基于市场环境自动调整策略参数）

**回测系统：**

- 现货策略回测：使用现货历史数据进行模拟交易
- 合约策略回测：使用合约历史数据，考虑杠杆和资金费率
- 条件组合优化回测：测试不同条件组合的效果
- 通知准确性回测：验证通知触发的准确性
- 自动下单回测：验证自动执行的效果

### 系统集成与监控

**统一监控面板：**

- 条件触发实时监控
- 自动下单执行状态
- 通知发送统计
- 策略运行健康度
- 风险指标监控

**日志系统：**

- 条件触发日志
- 自动下单执行日志
- 通知发送日志
- 异常错误日志
- 策略性能日志

**验收标准：**

- 现货条件触发成功率 ≥ 99%
- 合约条件触发成功率 ≥ 99%
- 自动下单执行成功率 ≥ 98%
- 通知发送准确率 ≥ 99%
- 条件组合处理延迟 ≤ 500ms
- 策略运行稳定 ≥ 24小时连续执行
- 回测结果误差 ≤ 0.5%
- 现货与合约策略数据完全分离

---

## 九、账户与盈亏系统

### 现货账户管理

- 支持多个交易所现货账户汇总
- 现货资产：可用余额、冻结资金
- 现货持仓展示：币种、数量、成本价、现价、浮盈亏、盈亏率
- 现货资产分布图与历史资产曲线
- 现货订单与实时委托（可筛选/导出）

### 合约账户管理

- 支持多个交易所合约账户汇总
- 合约资产：可用保证金、已用保证金、风险率
- 合约持仓展示：合约名称、方向、数量、杠杆、保证金、成本价、现价、浮动盈亏
- 合约账户风险率实时监控
- 合约账户资产分布与历史曲线

### 盈亏计算系统

**现货盈亏计算：**

```
现货PnL = (现货当前价 - 现货成本价) × 现货数量 - 现货手续费
```

**合约盈亏计算：**

```
合约PnL = (合约平仓价 - 合约开仓价) × 合约数量 × 合约方向 × 合约乘数 - 合约手续费 - 资金费率成本
合约收益率 = PnL / 投入保证金 × 100%
```

### 盈亏分析报表

- 现货交易盈亏分析：胜率、盈亏比、最大回撤
- 合约交易盈亏分析：考虑杠杆因素的收益分析
- 跨市场套利分析：现货与合约间套利收益
- 报告生成：现货日报/周报/月报、合约日报/周报/月报（PDF/CSV）

**验收标准：**

- 数据同步延迟 ≤ 1秒
- 现货盈亏计算误差 ≤ 0.5%
- 合约盈亏计算误差 ≤ 0.5%
- 报表导出准确率 ≥ 99%
- 现货与合约账户数据完全分离

---

## 十、AI 模型集成

### 本地模型

**现货分析模型：**

- LSTM：现货价格趋势预测
- LightGBM：现货信号评分
- RL模型：现货策略动态调参

**合约分析模型：**

- LSTM：合约价格趋势预测（考虑资金费率影响）
- LightGBM：合约信号评分
- RL模型：合约杠杆与仓位动态调参

### 云端模型

- GPT / Claude：策略解释、现货/合约报告生成、自然语言指令解析
- 现货市场分析与策略建议
- 合约市场分析与风险管理建议

### AI联动功能

**现货AI功能：**

- 现货市场预测（涨/跌/震荡 概率）
- 现货策略优化建议
- 现货盈亏诊断与行为分析
- 现货自然语言策略构建

**合约AI功能：**

- 合约市场预测（考虑资金费率）
- 合约策略优化建议
- 合约风险预警与仓位建议
- 合约自然语言策略构建

**跨市场AI功能：**

- 现货与合约套利机会识别
- 跨交易所价差分析
- 联合多交易所数据的综合建模

**验收标准：**

- 模型响应 ≤ 2秒
- 现货策略收益率提升 ≥ 10%
- 合约策略收益率提升 ≥ 10%
- 报告生成准确率 ≥ 90%

---

## 十一、系统与风控

### 现货风控

- 现货最大仓位限制
- 现货异常交易检测与自动暂停
- 现货API限速、连接重试、断线恢复
- 现货交易限额与风控联动

### 合约风控

- 合约杠杆倍数上限控制
- 合约保证金充足率监控
- 合约强制平仓风险预警
- 合约资金费率异常风控

### 综合风控机制

- 现货异动触发风控联动（现货高波动自动减仓）
- 合约异动触发风控联动（合约高波动自动减仓或增加保证金）
- 日志与警报记录持久化
- Windows系统级异常监控

**验收标准：**

- 现货风控响应 ≤ 1秒
- 合约风控响应 ≤ 1秒
- 异常捕获率 ≥ 99%
- 误判率 ≤ 2%
- 现货与合约风控完全独立

---

## 十二、性能与兼容性

| 指标     | 目标         | 说明             |
| ------ | ---------- | -------------- |
| 前端帧率   | ≥ 60FPS    | Windows桌面端优化   |
| 启动时间   | < 10秒      | Windows系统加载时间  |
| 内存占用   | < 500MB    | Windows桌面端内存使用 |
| 网络恢复   | 重连 ≤ 3秒    | Windows网络恢复机制  |
| 异常崩溃   | 0 次 / 24小时 | Windows稳定性保证   |
| 现货数据处理 | ≤ 500ms    | 现货数据实时处理延迟     |
| 合约数据处理 | ≤ 300ms    | 合约数据实时处理延迟     |

---

## 十三、项目目录建议

```
/core/                     # 后端核心逻辑
│   ├── exchange_adapters/ # 双交易所适配器（币安/OKX现货/合约分离）
│   │   ├── binance_adapter/   # 币安适配器
│   │   │   ├── spot_adapter.py     # 币安现货适配器
│   │   │   ├── futures_adapter.py  # 币安合约适配器
│   │   │   └── constants.py        # 币安常量配置
│   │   ├── okx_adapter/           # OKX适配器
│   │   │   ├── spot_adapter.py         # OKX现货适配器
│   │   │   ├── derivatives_adapter.py  # OKX衍生品适配器
│   │   │   └── constants.py            # OKX常量配置
│   │   └── base_adapter.py        # 基础适配器抽象类
│   ├── strategies/        # 策略引擎（现货/合约策略分离）
│   ├── condition_engine/  # 条件触发引擎
│   │   ├── price_conditions.py    # 价格条件处理器
│   │   ├── indicator_conditions.py # 技术指标条件处理器
│   │   ├── volume_conditions.py   # 成交量条件处理器
│   │   ├── time_conditions.py     # 时间条件处理器
│   │   └── market_alert_conditions.py # 市场异动条件处理器
│   ├── auto_trading/      # 自动交易引擎
│   │   ├── order_manager.py       # 订单管理器
│   │   ├── execution_engine.py    # 执行引擎
│   │   ├── risk_checker.py        # 风险检查器
│   │   └── position_manager.py    # 仓位管理器
│   ├── notification/      # 通知系统
│   │   ├── notify_manager.py      # 通知管理器
│   │   ├── channels/              # 通知渠道
│   │   │   ├── popup.py          # 系统弹窗
│   │   │   ├── desktop.py        # Windows桌面通知
│   │   │   ├── telegram.py       # Telegram机器人
│   │   │   ├── email.py          # 邮件通知
│   │   │   └── sound.py          # 声音提醒
│   │   └── templates/            # 通知模板
│   ├── ai_models/         # AI模型（现货/合约模型分离）
│   ├── risk_management/   # 风控系统（现货/合约风控分离）
│   └── data_aggregator/   # 数据聚合器
├── ui/                    # 前端Flutter界面
│   ├── spot_trade/        # 现货交易页面
│   │   ├── auto_order/    # 现货自动下单配置
│   │   └── condition_alerts/ # 现货条件提醒设置
│   ├── futures_trade/     # 合约交易页面
│   │   ├── auto_order/    # 合约自动下单配置
│   │   └── condition_alerts/ # 合约条件提醒设置
│   ├── strategy_center/   # 策略中心
│   │   ├── condition_builder/ # 条件组合构建器
│   │   ├── auto_trading/  # 自动交易管理
│   │   └── notification_center/ # 通知中心
│   ├── market/            # 行情展示
│   │   └── alerts_panel/  # 市场异动面板
│   └── account_center/    # 账户中心
├── config/                # 系统配置与数据源定义
│   ├── conditions/        # 条件配置模板
│   ├── notifications/     # 通知配置
│   └── auto_trading/      # 自动交易配置
├── logs/                  # 系统运行日志
│   ├── conditions/        # 条件触发日志
│   ├── auto_orders/       # 自动下单日志
│   └── notifications/     # 通知发送日志
├── database/              # SQLite数据库文件
│   ├── conditions.db      # 条件配置数据库
│   ├── auto_orders.db     # 自动下单记录数据库
│   └── notifications.db   # 通知历史数据库
├── tests/                 # 自动化测试
│   ├── test_conditions/   # 条件测试
│   ├── test_auto_trading/ # 自动交易测试
│   └── test_notifications/# 通知系统测试
└── docs/                  # 项目文档
```

---

## 十四、现货与合约功能对照表

| 功能模块 | 币安现货交易       | 币安合约交易            | OKX现货交易      | OKX衍生品交易          | 数据分离   |
| ---- | ------------ | ----------------- | ------------ | ----------------- | ------ |
| 交易面板 | 现货下单（限价/市价）  | 合约下单（开仓/平仓/止损/止盈） | 现货下单（限价/市价）  | 合约下单（开仓/平仓/止损/止盈） | ✓ 完全分离 |
| 行情展示 | 现货价格、K线、深度   | 合约价格、K线、深度、资金费率   | 现货价格、K线、深度   | 合约价格、K线、深度、资金费率   | ✓ 完全分离 |
| 策略系统 | 现货网格、马丁格尔、套利 | 合约趋势、震荡、网格、马丁格尔   | 现货网格、马丁格尔、套利 | 合约趋势、震荡、网格、马丁格尔   | ✓ 完全分离 |
| 账户管理 | 现货余额、持仓      | 合约保证金、持仓、风险率      | 现货余额、持仓      | 衍生品保证金、持仓、风险率     | ✓ 完全分离 |
| 风控系统 | 现货限额、异常检测    | 合约杠杆、保证金、强平风险     | 现货限额、异常检测    | 衍生品杠杆、保证金、强平风险    | ✓ 完全分离 |
| AI分析 | 现货预测、策略优化    | 合约预测、风险管理         | 现货预测、策略优化    | 衍生品预测、风险管理        | ✓ 完全分离 |

---

## 十五、开发验收标准总览

| 模块         | 验收条件           | 指标             | 备注               |
| ---------- | -------------- | -------------- | ---------------- |
| 平台兼容性      | Windows桌面端稳定运行 | 崩溃率 = 0        | 仅Windows平台       |
| 双交易所架构     | 币安+OKX完整功能实现   | 成功率100%        | 现货/合约适配器分离       |
| 现货行情系统     | 现货行情刷新及时       | 延迟 ≤ 1s        | 现货数据处理           |
| 合约行情系统     | 合约行情刷新及时       | 延迟 ≤ 1s        | 合约数据处理           |
| 市场异动       | 异动检测准确         | 误差 ≤ 5%        | 现货/合约分别检测        |
| **条件触发系统** | **多条件组合处理准确**  | **准确率 ≥ 99%**  | **AND/OR/NOT逻辑** |
| **条件触发系统** | **条件判断延迟**     | **延迟 ≤ 500ms** | **复合条件实时处理**     |
| **通知系统**   | **通知发送成功率**    | **≥ 99%**      | **多渠道通知保证**      |
| **通知系统**   | **通知推送延迟**     | **≤ 3s**       | **实时通知推送**       |
| **自动下单系统** | **自动执行成功率**    | **≥ 98%**      | **自动交易执行**       |
| **自动下单系统** | **风险控制有效性**    | **100%**       | **下单前检查验证**      |
| **自动下单系统** | **异常处理机制**     | **自动恢复 ≤ 3s**  | **故障自动恢复**       |
| 现货策略系统     | 条件触发稳定         | 成功率 ≥ 99%      | 现货策略独立运行         |
| 合约策略系统     | 条件触发稳定         | 成功率 ≥ 99%      | 合约策略独立运行         |
| AI模块       | 报告生成与预测准确      | ≥ 90%          | 现货/合约模型分离        |
| 现货账户系统     | 盈亏计算稳定         | 误差 ≤ 0.5%      | 现货数据准确           |
| 合约账户系统     | 盈亏计算稳定         | 误差 ≤ 0.5%      | 合约数据准确           |
| 风控系统       | 实时保护有效         | 延迟 ≤ 1s        | 现货/合约风控独立        |
| UI体验       | 流畅、清晰、无卡顿      | FPS ≥ 60       | Windows桌面优化      |
| **条件构建器**  | **条件配置便利性**    | **可视化操作**      | **拖拽式条件组合**      |
| **监控面板**   | **实时监控更新**     | **≤ 1s**       | **执行状态实时显示**     |

---

**项目开发注意事项：**

1. **双交易所优先策略**，先完善币安和OKX核心功能，再扩展其他交易所
2. **严格分离现货和合约功能**，确保数据、策略、账户完全隔离
3. **Windows桌面端专项优化**，不兼容其他平台
4. **本地部署为主**，确保数据安全性和系统稳定性
5. **模块化架构设计**，预留扩展接口便于后续添加新交易所
6. **AI模型本地化**，降低延迟并保护策略机密
7. **完善的风控体系**，特别是合约交易的杠杆风险控制
8. **实时性能优化**，确保交易执行的及时性和准确性
9. **币安优先策略**：币安作为主数据源，OKX作为备用
10. **标准化接口设计**，确保后续交易所接入的便利性

---

## 十六、条件触发与自动交易功能完整特性

| 功能类别       | 子功能         | 现货支持 | 合约支持 | 特性描述                      |
| ---------- | ----------- | ---- | ---- | ------------------------- |
| **条件触发引擎** | 价格条件        | ✓    | ✓    | 高于/低于/等于指定价格，支持多交易所       |
|            | 技术指标条件      | ✓    | ✓    | MA、EMA、MACD、RSI、BOLL等技术指标 |
|            | 成交量条件       | ✓    | ✓    | 成交量突增、异动检测，支持时间窗口         |
|            | 资金流向条件      | ✓    | ✓    | 净流入/净流出达到指定阈值             |
|            | 资金费率条件      | -    | ✓    | 合约资金费率变化触发（仅合约）           |
|            | 时间条件        | ✓    | ✓    | 定时触发、交易时段判断、工作日/周末        |
|            | 市场异动条件      | ✓    | ✓    | 市场波动、异常事件自动触发             |
|            | 组合条件        | ✓    | ✓    | AND、OR、NOT逻辑，支持多层嵌套       |
| **通知系统**   | 系统弹窗        | ✓    | ✓    | 即时弹窗提醒，支持自定义内容            |
|            | Windows桌面通知 | ✓    | ✓    | 系统原生通知，静默时段设置             |
|            | Telegram机器人 | ✓    | ✓    | 实时推送到手机，支持群组通知            |
|            | 邮件通知        | ✓    | ✓    | SMTP发送，支持附件和HTML格式        |
|            | 声音提醒        | ✓    | ✓    | 自定义提醒音，支持音量调节             |
|            | LED灯闪烁      | ✓    | ✓    | 硬件设备提醒（可选）                |
| **自动下单系统** | 限价单         | ✓    | ✓    | 指定价格买入/卖出，自动执行            |
|            | 市价单         | ✓    | ✓    | 市价立即执行，自动下单               |
|            | 止盈止损单       | ✓    | ✓    | 盈利/亏损自动平仓，风险控制            |
|            | 批量下单        | ✓    | ✓    | 多币种组合交易，一键执行              |
|            | 网格挂单        | ✓    | ✓    | 区间价格挂单，自动管理仓位             |
|            | 对冲下单        | ✓    | ✓    | 现货对冲合约风险，自动平衡             |
|            | 条件联动单       | ✓    | ✓    | 止盈单触发后自动设置新止损单            |
| **智能特性**   | AI条件推荐      | ✓    | ✓    | 基于历史数据推荐最优条件组合            |
|            | 自动参数优化      | ✓    | ✓    | 机器学习自动调整策略参数              |
|            | 风险评估        | ✓    | ✓    | 下单前自动风险评估和限额检查            |
|            | 执行监控        | ✓    | ✓    | 实时监控执行状态，故障自动恢复           |
|            | 回测验证        | ✓    | ✓    | 历史数据回测条件有效性               |
| **管理功能**   | 条件模板库       | ✓    | ✓    | 预设常用条件模板，一键应用             |
|            | 执行历史        | ✓    | ✓    | 完整的条件触发和下单执行记录            |
|            | 统计分析        | ✓    | ✓    | 成功率统计、收益分析、风险评估           |
|            | 参数调优        | ✓    | ✓    | 可视化参数调整，即时生效              |
| **风险控制**   | 余额验证        | ✓    | ✓    | 下单前检查账户余额充足性              |
|            | 风险率检查       | ✓    | ✓    | 持仓风险率实时监控，超限自动阻止          |
|            | 价格偏离检查      | ✓    | ✓    | 价格偏离市价过大时自动拒绝下单           |
|            | 异常价格过滤      | ✓    | ✓    | 检测异常价格波动，防止误触发            |
|            | 重试机制        | ✓    | ✓    | 下单失败自动重试，异常自动切换           |
|            | 断线恢复        | ✓    | ✓    | 网络断线自动重连，恢复挂单状态           |

---

## 十七、双交易所架构优势与发展规划

### 当前架构优势

**币安 + OKX 双交易所策略：**

1. **功能完整性**
   
   - 覆盖主流交易所，覆盖率超过60%的加密货币交易量
   - 现货和合约功能完备，满足专业交易需求
   - 两个交易所提供更好的价格发现和套利机会

2. **技术优势**
   
   - 专门的适配器设计，确保每个交易所功能最大化
   - 币安优先策略：作为主数据源，OKX作为备用和补充
   - 现货和合约数据完全独立处理，避免数据混淆

3. **风险管理**
   
   - 双交易所数据交叉验证，提高数据准确性
   - 一个交易所故障时自动切换到另一个
   - 分散化风险：不必依赖单一交易所

### 扩展发展规划

**阶段一：核心功能完善（当前阶段）**

- ✅ 币安现货 + 合约完整功能
- ✅ OKX现货 + 衍生品完整功能  
- ✅ 双交易所条件触发和自动下单
- ✅ 现货/合约策略系统完善
- ✅ 账户管理和风险控制

**阶段二：新增交易所（后续扩展）**

- 🔄 Bybit：补充合约交易功能
- 🔄 Coinbase：覆盖美区市场
- 🔄 KuCoin：支持更多山寨币
- 🔄 Gate.io：补充新币种

**阶段三：专业化扩展**

- 🔄 期货交易所：CME、Bakkt等传统期货
- 🔄 去中心化交易所：Uniswap、PancakeSwap
- 🔄 新兴交易所：快速接入新平台

### 扩展技术准备

**标准化接口设计：**

```python
# 预留扩展接口标准
class ExchangeAdapterRegistry:
    """交易所适配器注册表"""

    SUPPORTED_EXCHANGES = {
        'binance': BinanceAdapter,
        'okx': OKXAdapter,
        'bybit': BybitAdapter,      # 预留
        'coinbase': CoinbaseAdapter, # 预留
        'kucoin': KuCoinAdapter,     # 预留
    }

    @classmethod
    def register_exchange(cls, exchange_name: str, adapter_class: Type[BaseAdapter]):
        """注册新的交易所适配器"""
        cls.SUPPORTED_EXCHANGES[exchange_name] = adapter_class
```

**扩展指南文档：**

- `future_expansion/README.md` 详细说明新交易所接入流程
- 标准化测试套件确保新交易所功能完整性
- 配置模板和部署指南

---

本方案完整整合了您的修改要求，明确区分了现货和合约交易功能，采用币安和OKX双交易所架构，强调了Windows桌面端的本地部署特性，并新增了强大的条件触发通知和自动下单功能。系统优先完善核心双交易所功能，预留标准化扩展接口，确保在功能完善后再逐步扩展到其他交易所，实现系统的专业性、安全性和可扩展性。