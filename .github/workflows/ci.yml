name: CI Pipeline - Cryptocurrency Trading Terminal

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'README*'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'README*'
  workflow_dispatch:
    inputs:
      test_exchange_connections:
        description: 'Test exchange API connections'
        required: false
        default: false
        type: boolean

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.3'
        channel: 'stable'
        
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.14'
        
    - name: ç¼“å­˜Flutterä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ${{ runner.tool_cache }}/flutter
          ~/.pub-cache
        key: ${{ runner.os }}-flutter-${{ env.flutter-version }}
        
    - name: å®‰è£…Flutterä¾èµ–
      run: flutter pub get
      
    - name: æ£€æŸ¥Flutterä»£ç æ ¼å¼
      run: flutter format --set-exit-if-changed .
      
    - name: è¿è¡ŒFlutterä»£ç åˆ†æž
      run: flutter analyze --no-pub
      
    # Pythonä»£ç è´¨é‡æ£€æŸ¥
    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt || echo "No requirements.txt found"
        
    - name: å®‰è£…ä»£ç è´¨é‡å·¥å…·
      run: |
        pip install flake8 pylint black mypy isort bandit
        
    - name: æ£€æŸ¥Pythonä»£ç æ ¼å¼ (Black)
      run: python -m black --check --diff .
      
    - name: æŽ’åºPythonå¯¼å…¥ (isort)
      run: python -m isort --check-only --diff .
      
    - name: è¿è¡ŒFlake8ä»£ç æ£€æŸ¥
      run: python -m flake8 . --max-line-length=88 --ignore=E203,W503 --exclude=build,.git,.tox,.pytest_cache
        
    - name: è¿è¡ŒPylintæ£€æŸ¥
      run: python -m pylint --output-format=text --reports=no lib/ || echo "No lib directory found"
      
    - name: è¿è¡Œç±»åž‹æ£€æŸ¥ (mypy)
      run: python -m mypy . --ignore-missing-imports || echo "mypy check completed with warnings"

  # Flutteræž„å»ºæµ‹è¯•
  flutter-build:
    name: Flutteræž„å»ºæµ‹è¯•
    runs-on: windows-latest
    needs: code-quality
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.3'
        channel: 'stable'
        
    - name: ç¼“å­˜Flutterä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ${{ runner.tool_cache }}/flutter
          ~/.pub-cache
        key: ${{ runner.os }}-flutter-${{ env.flutter-version }}
        
    - name: èŽ·å–ä¾èµ–
      run: flutter pub get
      
    - name: è¿è¡ŒFlutteræµ‹è¯•
      run: flutter test --no-pub --coverage --reporter=expanded
      
    - name: ç”Ÿæˆæµ‹è¯•è¦†ç›–çŽ‡æŠ¥å‘Š
      if: success()
      run: |
        if exist coverage\lcov.info (
          pip install codecov
          codecov
        )
        
    - name: æž„å»ºFlutter Windowsåº”ç”¨
      run: flutter build windows --release --no-pub
      
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: flutter-windows-build
        path: build/windows/x64/release/

  # Pythonæ¨¡å—æµ‹è¯•
  python-tests:
    name: Pythonæ¨¡å—æµ‹è¯•
    runs-on: windows-latest
    needs: code-quality
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.14'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-asyncio
        pip install -r requirements.txt || echo "No requirements.txt found"
        
    - name: è¿è¡ŒPythonæµ‹è¯•
      run: |
        if exist tests (
          python -m pytest tests/ --cov=. --cov-report=xml --cov-report=html --maxfail=3
        ) else (
          echo "No tests directory found"
        )
        
    - name: ä¸Šä¼ Pythonè¦†ç›–çŽ‡æŠ¥å‘Š
      if: success() && always()
      uses: actions/upload-artifact@v3
      with:
        name: python-coverage-reports
        path: |
          coverage.xml
          htmlcov/

  # å®‰å…¨æ£€æŸ¥
  security-check:
    name: å®‰å…¨æ£€æŸ¥
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.14'
        
    - name: å®‰è£…Banditå®‰å…¨æ‰«æ
      run: pip install bandit[toml]
      
    - name: è¿è¡ŒBanditå®‰å…¨æ‰«æ
      run: bandit -r . -f json -o bandit-report.json || echo "Security scan completed"
      
    - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: security-report
        path: bandit-report.json

  # ä¾èµ–æ£€æŸ¥
  dependency-check:
    name: ä¾èµ–å®‰å…¨æ£€æŸ¥
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.14'
        
    - name: å®‰è£…pip-audit
      run: pip install pip-audit
      
    - name: æ£€æŸ¥Pythonä¾èµ–æ¼æ´ž
      run: pip-audit --format=json --output=pip-audit-report.json || echo "Dependency check completed"
      
    - name: ä¸Šä¼ ä¾èµ–æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: dependency-audit-report
        path: pip-audit-report.json

  # Dockeræž„å»ºæµ‹è¯•
  docker-build:
    name: Dockeræž„å»ºæµ‹è¯•
    runs-on: windows-latest
    if: contains(github.event.head_commit.message, '[docker]') || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: æž„å»ºå¼€å‘çŽ¯å¢ƒé•œåƒ
      if: success()
      run: |
        if exist Dockerfile (
          docker build -t trading-terminal:dev-${{ github.sha }} --target development .
        ) else (
          echo "No Dockerfile found, skipping Docker build"
        )
        
    - name: æž„å»ºåŽç«¯é•œåƒ
      if: success()
      run: |
        if exist Dockerfile (
          docker build -t trading-terminal:backend-${{ github.sha }} --target backend .
        ) else (
          echo "No Dockerfile found, skipping backend build"
        )
        
    - name: è¿è¡Œå®¹å™¨å¥åº·æ£€æŸ¥
      if: success()
      run: |
        docker run -d --name health-check trading-terminal:backend-${{ github.sha }}
        sleep 10
        docker logs health-check || echo "Container logs retrieved"
        docker stop health-check || echo "Container stopped"
        docker rm health-check || echo "Container removed"
        
    - name: ä¸Šä¼ Dockeré•œåƒä¿¡æ¯
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: docker-build-info
        path: |
          docker-images.txt
        retention-days: 1

  # äº¤æ˜“APIè¿žæŽ¥æµ‹è¯•ï¼ˆæ¨¡æ‹Ÿï¼‰
  exchange-api-test:
    name: äº¤æ˜“æ‰€APIè¿žæŽ¥æµ‹è¯•
    runs-on: windows-latest
    if: github.event.inputs.test_exchange_connections == 'true' || contains(github.event.head_commit.message, '[test-api]')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.14'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install ccxt pytest-asyncio aiohttp
        
    - name: åˆ›å»ºæ¨¡æ‹ŸAPIæµ‹è¯•
      run: |
        mkdir -p tests/api
        cat > tests/api/test_api_simulation.py << 'EOF'
        import asyncio
        import aiohttp
        import ccxt.async_support as ccxt
        from unittest.mock import AsyncMock, patch
        
        async def test_binance_connection():
            # æ¨¡æ‹Ÿå¸å®‰APIè¿žæŽ¥æµ‹è¯•
            try:
                # ä½¿ç”¨æµ‹è¯•ç½‘ç«¯ç‚¹
                binance = ccxt.binance({
                    'sandbox': True,
                    'apiKey': 'test_key',
                    'secret': 'test_secret',
                    'enableRateLimit': True,
                })
                
                # æµ‹è¯•è¿žæŽ¥æ€§ï¼ˆä¸è¿›è¡ŒçœŸå®žäº¤æ˜“ï¼‰
                status = await binance.load_markets()
                print(f"âœ… Binance API: è¿žæŽ¥æˆåŠŸï¼ŒåŠ è½½äº† {len(status)} ä¸ªäº¤æ˜“å¯¹")
                return True
            except Exception as e:
                print(f"âŒ Binance API: è¿žæŽ¥å¤±è´¥ - {str(e)}")
                return False
        
        async def test_okx_connection():
            # æ¨¡æ‹ŸOKX APIè¿žæŽ¥æµ‹è¯•
            try:
                okx = ccxt.okx({
                    'sandbox': True,
                    'apiKey': 'test_key',
                    'secret': 'test_secret',
                    'enableRateLimit': True,
                })
                
                # æµ‹è¯•è¿žæŽ¥æ€§
                status = await okx.load_markets()
                print(f"âœ… OKX API: è¿žæŽ¥æˆåŠŸï¼ŒåŠ è½½äº† {len(status)} ä¸ªäº¤æ˜“å¯¹")
                return True
            except Exception as e:
                print(f"âŒ OKX API: è¿žæŽ¥å¤±è´¥ - {str(e)}")
                return False
        
        async def main():
            print("ðŸš€ å¼€å§‹äº¤æ˜“æ‰€APIè¿žæŽ¥æµ‹è¯•...")
            
            binance_result = await test_binance_connection()
            okx_result = await test_okx_connection()
            
            if binance_result and okx_result:
                print("ðŸŽ‰ æ‰€æœ‰äº¤æ˜“æ‰€APIè¿žæŽ¥æµ‹è¯•é€šè¿‡")
                return 0
            else:
                print("âš ï¸  éƒ¨åˆ†äº¤æ˜“æ‰€APIè¿žæŽ¥æµ‹è¯•å¤±è´¥")
                return 1
        
        if __name__ == "__main__":
            exit_code = asyncio.run(main())
            exit(exit_code)
        EOF
        
    - name: è¿è¡ŒAPIè¿žæŽ¥æµ‹è¯•
      run: |
        python tests/api/test_api_simulation.py
        
    - name: ä¸Šä¼ APIæµ‹è¯•æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: exchange-api-test-report
        path: tests/api/

  # æž„å»ºçŠ¶æ€æ±‡æ€»
  build-summary:
    name: æž„å»ºçŠ¶æ€æ±‡æ€»
    runs-on: ubuntu-latest
    needs: [code-quality, flutter-build, python-tests, security-check, dependency-check]
    if: always()
    
    steps:
    - name: æ±‡æ€»æž„å»ºçŠ¶æ€
      run: |
        echo "ðŸŽ¯ CI Pipeline Results:"
        echo "========================"
        echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.code-quality.result }}"
        echo "ðŸ”¨ Flutteræž„å»ºæµ‹è¯•: ${{ needs.flutter-build.result }}"
        echo "ðŸ Pythonæ¨¡å—æµ‹è¯•: ${{ needs.python-tests.result }}"
        echo "ðŸ”’ å®‰å…¨æ£€æŸ¥: ${{ needs.security-check.result }}"
        echo "ðŸ“¦ ä¾èµ–æ£€æŸ¥: ${{ needs.dependency-check.result }}"
        echo "========================"
        
        if [[ "${{ needs.code-quality.result }}" == "success" && 
              "${{ needs.flutter-build.result }}" == "success" && 
              "${{ needs.python-tests.result }}" == "success" ]]; then
          echo "ðŸŽ‰ CI Pipeline PASSED - æ‰€æœ‰æ ¸å¿ƒæ£€æŸ¥é€šè¿‡"
          exit 0
        else
          echo "âŒ CI Pipeline FAILED - è¯·æ£€æŸ¥å¤±è´¥çš„æ­¥éª¤"
          exit 1
        fi