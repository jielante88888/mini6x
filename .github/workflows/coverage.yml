name: Code Coverage Report

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  coverage-report:
    name: ä»£ç è¦†ç›–ç‡æŠ¥å‘Š
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.3'
        channel: 'stable'
        
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.14'
        
    - name: å®‰è£…Flutterä¾èµ–å¹¶è¿è¡Œæµ‹è¯•
      run: |
        flutter pub get
        flutter test --no-pub --coverage --reporter=expanded
        
    - name: å®‰è£…Pythonæµ‹è¯•ä¾èµ–
      run: |
        pip install pytest pytest-cov coverage codecov
        
    - name: è¿è¡ŒPythonæµ‹è¯•
      run: |
        if exist tests (
          python -m pytest tests/ --cov=. --cov-report=xml --cov-report=html --maxfail=3
        ) else (
          echo "No tests directory found, creating empty coverage"
          mkdir -p htmlcov
          echo "<html><body><h1>No tests directory found</h1></body></html>" > htmlcov/index.html
        )
        
    - name: å®‰è£…lcov
      run: sudo apt-get update && sudo apt-get install -y lcov
      
    - name: è½¬æ¢Flutterè¦†ç›–ç‡
      run: |
        if exist coverage/lcov.info (
          lcov --list coverage/lcov.info || echo "No lcov data"
        ) else (
          echo "No Flutter coverage data found"
        )
        
    - name: ä¸Šä¼ Flutterè¦†ç›–ç‡åˆ°Codecov
      if: success()
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage/lcov.info
        flags: flutter
        name: flutter-coverage
        fail_ci_if_error: false
        
    - name: ä¸Šä¼ Pythonè¦†ç›–ç‡åˆ°Codecov
      if: success()
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: python
        name: python-coverage
        fail_ci_if_error: false
        
    - name: ç”Ÿæˆç»¼åˆè¦†ç›–ç‡æŠ¥å‘Š
      run: |
        echo "# ğŸ“Š ä»£ç è¦†ç›–ç‡æŠ¥å‘Š" > coverage-summary.md
        echo "ç”Ÿæˆæ—¶é—´: $(date)" >> coverage-summary.md
        echo "" >> coverage-summary.md
        echo "## Flutterè¦†ç›–ç‡" >> coverage-summary.md
        if [ -f "coverage/lcov.info" ]; then
          echo "âœ… Flutteræµ‹è¯•è¦†ç›–ç‡å·²ç”Ÿæˆ" >> coverage-summary.md
        else
          echo "âš ï¸ æš‚æ— Flutterè¦†ç›–ç‡æ•°æ®" >> coverage-summary.md
        fi
        echo "" >> coverage-summary.md
        echo "## Pythonè¦†ç›–ç‡" >> coverage-summary.md
        if [ -f "coverage.xml" ]; then
          echo "âœ… Pythonæµ‹è¯•è¦†ç›–ç‡å·²ç”Ÿæˆ" >> coverage-summary.md
        else
          echo "âš ï¸ æš‚æ— Pythonè¦†ç›–ç‡æ•°æ®" >> coverage-summary.md
        fi
        
    - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: |
          coverage-summary.md
          htmlcov/
          coverage.xml
          coverage/lcov.info